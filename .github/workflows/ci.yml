name: CI Pipeline

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Job 1: VerificaciÃ³n de cÃ³digo y calidad
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ” InformaciÃ³n del entorno
        run: |
          echo "ðŸŽ¯ Rama: ${{ github.ref }}"
          echo "ðŸ”§ Evento: ${{ github.event_name }}"
          echo "ðŸ‘¤ Actor: ${{ github.actor }}"
          echo "ðŸ“¦ SHA: ${{ github.sha }}"
      
      - name: ðŸ“‹ Verificar estructura del proyecto
        run: |
          echo "ðŸ“ Estructura del proyecto:"
          ls -la
          echo ""
          echo "ðŸ” Buscando archivos importantes:"
          [ -f "docker-compose.yml" ] && echo "âœ… docker-compose.yml encontrado" || echo "âš ï¸ docker-compose.yml NO encontrado"
          [ -f "Makefile" ] && echo "âœ… Makefile encontrado" || echo "âš ï¸ Makefile NO encontrado"
          [ -d "src" ] && echo "âœ… Directorio src/ encontrado" || echo "âš ï¸ Directorio src/ NO encontrado"
          [ -f "README.md" ] && echo "âœ… README.md encontrado" || echo "âš ï¸ README.md NO encontrado"
  
  # Job 2: Build y validaciÃ³n de Docker
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ‹ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
      
      - name: ðŸ”§ Verificar Docker y Docker Compose
        run: |
          docker --version
          docker compose version

      
      - name: ðŸ“ Crear docker-compose.yml temporal si no existe
        run: |
          if [ ! -f "docker-compose.yml" ]; then
            echo "âš ï¸ docker-compose.yml no encontrado. Creando uno temporal para testing..."
            cat > docker-compose.yml << 'EOF'
          version: '3.8'
          services:
            test:
              image: alpine:latest
              command: echo "CI/CD Pipeline funcionando correctamente!"
          EOF
            echo "âœ… docker-compose.yml temporal creado"
          fi
      
      - name: ðŸ—ï¸ Validar sintaxis docker-compose
        run: docker compose config
      
      - name: ðŸš€ Test build (si existe Dockerfile)
        run: |
          if [ -f "Dockerfile" ]; then
            echo "ðŸ—ï¸ Construyendo imagen Docker..."
            docker build -t ci-test:latest .
          else
            echo "â„¹ï¸ No hay Dockerfile aÃºn, saltando build"
          fi
  
  # Job 3: Tests (placeholder para el futuro)
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ§ª Ejecutar tests
        run: |
          echo "ðŸ§ª Placeholder para futuros tests..."
          echo "ðŸ“ TODO: AÃ±adir tests unitarios"
          echo "ðŸ“ TODO: AÃ±adir tests de integraciÃ³n"
          echo "ðŸ“ TODO: AÃ±adir anÃ¡lisis de cobertura"
      
      - name: ðŸ“Š Reporte de salud del proyecto
        if: always()
        run: |
          echo "ðŸ“Š === REPORTE DE SALUD DEL PROYECTO ==="
          echo ""
          echo "âœ… CI/CD Pipeline: OPERATIVO"
          echo "â³ Docker Setup: PENDIENTE (Tareas 1.2-1.5)"
          echo "â³ Tests: PENDIENTE (Por implementar)"
          echo "â³ Servicios: PENDIENTE (Fase 2)"
          echo ""
          echo "ðŸŽ¯ Siguiente paso: Implementar docker-compose.yml con servicios base"
